<%- include('layouts/header') %>
         <!-- Breadcrumb Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="#">Home</a>
                    <span class="breadcrumb-item active">Checkout</span>
                </nav>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->


    <!-- Checkout Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-8">
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Billing Address</span></h5>
                <div class="bg-light p-30 mb-5">

                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label>First Name</label>
                            <input class="form-control" type="text" value="<%= user ? user.name : '' %>" placeholder="John">
                        </div>
                        <div class="col-md-6 form-group">
                            <label>E-mail</label>
                            <input class="form-control" type="email" value="<%= user ? user.email : '' %>" placeholder="example@email.com" readonly>
                        </div>
                        <div class="col-md-6 form-group">
                            <label>Mobile No</label>
                            <input class="form-control" type="text" placeholder="+123 456 789" value="<%= user.contact %>">
                        </div>
                        <div class="col-md-6 form-group">
                            <label>Address Line 1</label>
                            <input class="form-control" type="text" placeholder="123 Street" value="<%= user.address %>">
                        </div>

                        <div class="col-md-6 form-group">
                            <label>City</label>
                            <input class="form-control" type="text" placeholder="New York"  value="<%= user.city %>">
                        </div>
                        <div class="col-md-6 form-group">
                            <label>State</label>
                            <input class="form-control" type="text" placeholder="New York"  value="<%= user.state %>">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Order Total</span></h5>
                <div class="bg-light p-30 mb-5">
                    <div class="border-bottom">
                        <h6 class="mb-3">Products</h6>
                        <%  let subtotal = 0
                            let shipping = 0
                            if(cartItems) {
                            cartItems.forEach((cart)=>{
                            subtotal += cart.quantity * cart.total  
                            shipping += cart.items[0].product_id.shipping_price
                        %>
                            <div class="d-flex justify-content-between">
                               <p><%= cart.items[0].product_id.product_name %></p>
                               <p>Rs. <%= cart.quantity * cart.total %> </p>
                            </div>
                        <% })} %>
                    </div>
                    <div class="border-bottom pt-3 pb-2">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Subtotal</h6>
                            <h6>Rs. <%= subtotal %></h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Shipping</h6>
                            <h6 class="font-weight-medium">Rs. <%= shipping %></h6>
                        </div>
                    </div>
                    <div class="pt-2">
                        <div class="d-flex justify-content-between mt-2">
                            <h5>Total</h5>
                            <h5 id="total-amount">Rs. <%= subtotal + shipping %></h5>
                        </div>
                    </div>
                </div>
                <div class="mb-5">
                    <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Payment</span></h5>
                    <div class="bg-light p-30">
                        <!-- <div class="form-group">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" name="payment" id="paypal">
                                <label class="custom-control-label" for="paypal">Paypal</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" name="payment" id="directcheck">
                                <label class="custom-control-label" for="directcheck">Direct Check</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" name="payment" id="banktransfer">
                                <label class="custom-control-label" for="banktransfer">Bank Transfer</label>
                            </div>
                        </div> -->
                        <button id="payBtn"  class="btn btn-block btn-primary font-weight-bold py-3">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>


document.getElementById("payBtn").onclick = async function () {

 const Data = JSON.parse(`<%- JSON.stringify(cartItems) %>`);

  if(!Data.length > 0){
     alert('something went wrong')
     return false
  }
 const order = await fetch("/place-order", { 
    method: "POST" ,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({order:Data})
  }).then(res => res.json());
 
  const options = {

    key: "<%= key %>",
    amount: order.amount,
    currency: order.currency,
    name: "E Shop",
    description: "E shop Transaction",
    order_id: order.id,
    handler: async function (response) {

      const verify = await fetch("/verify-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(response)
      })

      if(verify.ok){
        alert('payment success');
        window.location.href ='/success'
      }else{
        alert('payment verify failed');
        
      }
    }
  };
 
  const rzp = new Razorpay(options);

  rzp.on('payment.failed', async(response) => {

    const payment_status = await fetch("/verify-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            razorpay_order_id: response.error.metadata.order_id,
            razorpay_payment_id: response.payment_id || null,
            payment_status: 'Failed',
        })
      })

      document.getElementById('toastContainer').innerHTML  = `
             <div class="toast align-items-center text-bg-danger border-0 show">
              <div class="d-flex align-items-center">
               <div class="toast-body">
                Payment Failed
               </div>
              <button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
             </div>
            </div>
      `

  });

  rzp.open();
 
};
</script>
<%- include('layouts/footer') %>